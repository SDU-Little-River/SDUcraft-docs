author@matcha

# 社团 MC 服务器运维 Playbook

> 本文档用于记录当前 MC 服务器及其相关基础设施的运维规范与注意事项，面向社团管理员与已授权的运维成员。内容以**可操作性与长期维护**为目标整理。

---

## 一、凭据与权限管理

- 所有服务器及相关服务的**账号密码**统一存放在 **WPS → 运维凭据共享表**中。
- 该表已设置访问权限，仅 **管理员** 与 **已申请并获批的成员** 可见。
- 如需获取权限，请主动联系**现有管理员**，不要私下传播或保存明文凭据。

---

## 二、服务器与网络访问说明

### 1. mcsm jn 服务器

- 由于所处 **IP 段性质限制**，默认 **无法直接访问 22 端口 SSH**。
- 当前已开放端口：
  - `22`
  - `2222`
- 主要业务：
  - **MCSM** 面板
  - **Docker**（承载以下服务）：
    - MC 游戏服务器容器
    - Zabbix（Server / Agent / Frontend / MySQL）
    - QQ Bot 相关业务

### 2. mcsm qd 服务器

- 拥有 **内网 IP**。
- 由于浏览器 **PNA（Private Network Access）限制**，且 mcsm jn 为外网 IP：
  - 无法在 **mcsm jn 的 Web 管理界面** 中直接连接 qd 的 Web SSH。
  - **建议统一使用 SSH 客户端**进行连接与管理。

---

## 三、监控与端口要求

- 当前 **Zabbix** 已完成以下监控配置：
  - mcsm jn：
    - 主机监控
    - Docker 容器监控
  - mcsm qd：
    - 主机监控
    - Docker 容器监控
- 请务必确保以下端口畅通：
  - `10051`（Zabbix Server）

---

## 四、现有服务器与服务概览

### 1. 211.87.*.* 服务器

- MCSM
- Zabbix Server + Agent
- Portainer

### 2. 101.76.*.* 服务器

#### PVE 节点
- MCSM

#### Web 服务
- Django（历史遗留项目，**非常老，不建议继续投入精力**）
- WordPress（新）：
  - 已由 **xhbsh** 完成主页设计
  - 文章内容尚未迁移，但预计成本不高

#### 其他
- Zabbix Agent
- Portainer

---

## 五、MC 实例与 Docker 使用规范

### 1. Docker 容器规范

- **新建 MC 实例时，强烈建议手动指定容器名称**：
  - 避免 `docker ps` 出现大量无意义随机字符串
  - 否则在故障排查时极其痛苦

- **必须检查卷挂载（Volume）**：
  - MCSM 新实例默认可能只挂载在宿主机本地
  - 请确认已正确挂载目录，保证数据**持久化**

### 2. 资源与稳定性

- 新实例创建时：
  - **务必设置内存上限**
  - 同时开启合理的**性能优化选项**
- 不限制内存的情况下，服务器**非常容易炸内存**

### 3. 日志与磁盘空间

- 以下内容极易导致 **磁盘爆满**：
  - Playbook（PB）备份
  - Ledger 审计
- 对策：
  - 设置**最大保留天数**
  - 定期检查磁盘占用

- Docker 日志：
  - 不要输出过多无意义日志
  - 检查是否启用了日志轮转 / 最大保留天数
  - 防止 Docker 日志无限增长

---

## 六、故障排查建议

- MC 服务启动失败时：
  - 第一时间查看 **日志（log）**
  - 重点关注关键词：
    - `ERROR`
    - `FATAL`
    - `CRITICAL`

---

## 七、命名与规范要求

- **所有 MC 新服务必须统一命名规范**：
  - 示例：四周目服务器统一以 `4th` 开头
  - 注意大小写一致
- 命名目标：
  - 一眼能看懂用途
  - 避免“草台班子”式混乱命名

---

## 八、网络与认证架构说明

- 四周目群组服技术栈：
  - Fabric + MCDR
  - Velocity：
    - 热切换
    - 前置认证
- 建议：
  - 多阅读相关官方文档（Docs）
  - 整体并不复杂，但需要理解原理

### 认证规则

- **不接入 Velocity 的服务器**：
  - 必须自行开启并配置认证
- **接入 Velocity 的服务器**：
  - 本身不需要再单独做认证

---

## 九、账号与文件管理

- 当前阶段：
  - **统一使用 root 用户即可**
  - 如需使用个人账户，也允许

- 无论使用何种账户：
  - 必须规范文件夹与文件命名
  - 无用文件及时清理
  - 不要在 Linux 系统中制造垃圾（请保持基本的运维素养）

---

## 十、证书与 HTTPS 维护

- 网站证书**非常容易忘记续期**：
  - 若未启用自动续期：
    - 使用 `acme` 脚本手动续期
- DNS 的 API Key：
  - 已保存在服务器中
- 操作完成后：
  - 务必确认是否已启用**自动续期**

---

## 十一、PVE 与防火墙（iptables）

- **iptables 对 PVE 非常关键**：
  - 若你负责服务器 Linux 运维，必须掌握其基本原理
  - 未完全理解前，禁止随意修改

- 修改完成后：
  - 一定要保存规则，覆盖现有配置：

```bash
iptables-save > /etc/iptables/rules.v4
```

---

> 本 Playbook 为持续维护文档，后续可根据实际运维经验不断补充与修订。
